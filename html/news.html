<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
  <title>title</title>
  <link rel="stylesheet" type="text/css" href="../css/api.css" />
  <link rel="stylesheet" type="text/css" href="../css/aui.css" />
  <style>
    @@font-face {
      src: url(./css/aui-iconfont.ttf);
    }
    .uibody{
      margin-top: 180px;margin-bottom: 51px;
    }
    .mfoot {
      position:relative;bottom:50px;
    }
    .aui-list-item{

      -moz-box-shadow: 1px 2px 8px #ededed; /* 老的 Firefox */
      box-shadow: 1px 2px 6px #ededed;
    }

  </style>
</head>


<body>
  <header class="aui-bar aui-bar-nav">畅读</header>
  <section>




  </section>


  <div class="aui-grid uibody">
    <div class="aui-row">

      <div class="aui-col-xs-4" tapmode onclick="fenlei(1)">
        <i class="aui-iconfont aui-icon-map"></i>
        <div class="aui-grid-label">教程</div>
      </div>
      <div class="aui-col-xs-4" tapmode onclick="fenlei(2)">
        <i class="aui-iconfont aui-icon-calendar"></i>
        <div class="aui-grid-label">PHP</div>
      </div>
      <div class="aui-col-xs-4" tapmode onclick="fenlei(3)">

        <i class="aui-iconfont aui-icon-date"></i>
        <div class="aui-grid-label">Linux</div>
      </div>

    </div>
    <div class="aui-hr"></div>
    <ul class="aui-list aui-media-list">
      <li class="aui-list-item aui-list-item-arrow">
        <div class="aui-media-list-item-inner">
          <div class="aui-list-item-inner">
            <div class="aui-list-item-text" tapmode >
              <div class="aui-list-item-title">每日新知</div>

            </div>


          </div>
        </div>
      </li>



    </ul>
  </div>




  <div >

    <ul class="aui-list aui-media-list mfoot" id="main">



    </ul>

  </div>

  <footer class="aui-bar aui-bar-tab">
    <div class="aui-bar-tab-item aui-active" tapmode >
      <i class="aui-iconfont aui-icon-home"></i>
      <div class="aui-bar-tab-label">首页</div>
    </div>
    <div class="aui-bar-tab-item" tapmode onclick="fnpang()">
      <i class="aui-iconfont aui-icon-star"></i>
      <div class="aui-bar-tab-label">排行榜</div>
    </div>

    <div class="aui-bar-tab-item" tapmode onclick="fnmy()">
      <div class="aui-dot"></div>
      <i class="aui-iconfont aui-icon-my"></i>
      <div class="aui-bar-tab-label">我的</div>
    </div>
  </footer>

</body>

<script type="text/javascript" src="../script/api.js"></script>

<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script id="template" type="text/template">
  {{~it:data}}
  <li class="aui-list-item aui-margin-t-10"  tapmode=''  onclick="details('{{=data.id}}','{{=data.content}}')">
    <div class="aui-media-list-item-inner">

      <div class="aui-list-item-inner">
        <div class="aui-list-item-text">
          <div class="aui-list-item-title aui-ellipsis-1">{{=data.title}}</div>

        </div>
        <div class="aui-list-item-text aui-ellipsis-2">
          {{=data.content}}
        </div>
        <div class="aui-info aui-margin-t-15" style="padding:0">
          <div class="aui-info-item">
            <img src="../image/liulangnan.png" style="width:1rem" class="aui-img-round" /><span class="aui-margin-l-5">{{=data.username}}</span>
          </div>
          <div class="aui-info-item">{{=data.createdAt.substr(0,10)}}</div>
        </div>
      </div>
      <div class="aui-list-item-media">
        {{if(data.img!=null){}}

        <img src="{{=data.img}}">

        {{ }else{}}
        <img src="../image/9.png">
        {{ } }}
      </div>
    </div>
  </li>


  {{~}}
</script>


<script>
  var Limits=6;
  var skip=0;

  apiready = function() {
    getlunbo();

    getnews(false);

    getMore();
  }
  function getMore(){

    api.addEventListener({
      name: 'scrolltobottom',
      extra: {
        threshold: 120 // 距离底部还有多少触发scrolltobottom事件
      }

    }, function(ret, err){
      getnews(true);


    });



  }



  function fnpang(){
    api.openWin({
      name: 'paihang',
      url: './paihang.html',
      pageParam: {
        status: 2
      }
    });

  }
  function fnmy(){
    api.openWin({
      name: 'my',
      url: './my.html',

    });

  }

  function fenlei(vals){
    api.removeEventListener({
      name: 'scrolltobottom'
    });

    var template=$api.byId('template');
    var dot=doT.template(template.innerHTML);
    var now = Date.now();
    var appKey = SHA1("A605018246573"+"UZ"+"D06D3410-B97B-02E8-7417-8109902C9261"+"UZ"+now)+"."+now;

    var params = {
      fields: {},

      where: {
        cate_id:vals
      },
      skip: skip,
      limit: Limits,
      order: "id DESC",
    }
    params = $api.jsonToStr(params);


    api.ajax({
      url: 'http://d.apicloud.com/mcm/api/news?filter=' + params,
      method: 'get',

      headers: {
        "X-APICloud-AppId": "A605018246573",
        "X-APICloud-AppKey": appKey
      }

    },function(ret, err){
      if (ret) {

        $api.html(main, dot(ret));

      } else {
        alert( JSON.stringify( err ) );
      }
    });

  }

  function details(id,content){
   api.openWin({
     name: 'contents',
     url: './content.html',
     pageParam: {
       id: id,
       content:content
     }
   });



 }


 function getnews(loadMore_){
  var template=$api.byId('template');
  var dot=doT.template(template.innerHTML);
  var now = Date.now();
  var appKey = SHA1("A605018246573"+"UZ"+"D06D3410-B97B-02E8-7417-8109902C9261"+"UZ"+now)+"."+now;


  if (!loadMore_) {
      // 显示加载状态对话框

      api.showProgress({
        style: 'default',
        animationType: 'fade',
        title: '努力加载中...',
        text: '请稍后.哦..',
        modal: false
      });


    }

    if (loadMore_) {

      Limits=Limits+4;

    } else {
      skip = 0;
    }



    var params = {
      fields: {},
      where: {
        "and": [
        {status:1},


        ]
      },
      skip: skip,
      limit: Limits,
      order: "id DESC",
    }
    params = $api.jsonToStr(params);

    api.ajax({
      url: 'http://d.apicloud.com/mcm/api/news?filter=' + params,
      method: 'get',

      headers: {
        "X-APICloud-AppId": "A605018246573",
        "X-APICloud-AppKey": appKey
      }

    },function(ret, err){
      if (ret) {
        api.hideProgress();
        $api.html(main, dot(ret));
        ret.length=ret.length+18;
        if(Limits>ret.length){
          api.toast({
            msg: '没有数据了',
            duration: 3000,
            location: 'bottom'
          });
          api.removeEventListener({
            name: 'scrolltobottom'
          });


        }

      } else {
        alert( JSON.stringify( err ) );
      }
    });

  }

  function details(id,content){
   api.openWin({
     name: 'contents',
     url: './content.html',
     pageParam: {
       id: id,
       content:content
     }
   });


 }
 function getlunbo(){
  var UIScrollPicture = api.require('UIScrollPicture');
  UIScrollPicture.open({
    rect: {
      x: 0,
      y: 45,
      w: api.winWidth,
      h:180
    },
    data: {
      paths: [
      'https://img3.doubanio.com/view/ark_campaign_pic/large/public/4776.jpg',
      'https://img1.doubanio.com/view/ark_campaign_pic/large/public/4778.jpg',
      'https://img1.doubanio.com/view/ark_campaign_pic/large/public/4778.jpg',
      'https://img3.doubanio.com/view/ark_campaign_pic/large/public/4781.jpg'
      ],

    },
    styles: {

      indicator: {
        align: 'center',
        color: '#f3f3f3',
        activeColor: '#DA70D6'
      }
    },
    placeholderImg: 'widget://res/slide1.jpg',
    contentMode: 'scaleToFill',
    interval: 3,
    fixedOn: api.frameName,
    loop: true,
    fixed: false
  }, function(ret, err) {
    if (ret) {
      // alert(JSON.stringify(ret));
    } else {
      // alert(JSON.stringify(err));
    }
  });


}

</script>

</html>
